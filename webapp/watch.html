<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reklam İzle</title>
  <style>
    body{font-family:system-ui,Arial;background:#0b1220;color:#fff;margin:0;padding:16px}
    .card{max-width:520px;margin:0 auto;background:#111a2e;border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .row{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .muted{opacity:.8;font-size:13px}
    .bar{height:10px;background:#223255;border-radius:999px;overflow:hidden;margin-top:10px}
    .bar>div{height:100%;width:0%;background:#4aa3ff;transition:width .3s}
    .err{color:#ff6b6b;font-size:13px;margin-top:8px}
    button{border:0;border-radius:10px;padding:10px 12px;background:#2a385c;color:#fff;cursor:pointer}
    video{width:100%;border-radius:14px;background:#000;margin-top:12px}
  </style>
</head>
<body>
  <div class="card">
    <div class="row">
      <div>
        <div style="font-size:18px;font-weight:700">Reklam izle</div>
        <div class="muted" id="info">Sayaç, video başlayınca başlar. Bitince ödül otomatik verilir.</div>
      </div>
      <button id="closeBtn">Kapat</button>
    </div>

    <div class="row" style="margin-top:14px">
      <div>
        <div class="muted">Kalan süre</div>
        <div style="font-size:22px;font-weight:800" id="left">--</div>
      </div>
      <div style="text-align:right">
        <div class="muted">Ödül</div>
        <div style="font-weight:700" id="reward">--</div>
      </div>
    </div>

    <div class="bar"><div id="barFill"></div></div>
    <video id="vid" playsinline controls></video>
    <div class="err" id="err"></div>
  </div>

<script>
  const qs = new URLSearchParams(location.search);
  const initData = qs.get('initData') || '';
  const closeBtn = document.getElementById('closeBtn');
  const vid = document.getElementById('vid');
  const leftEl = document.getElementById('left');
  const rewardEl = document.getElementById('reward');
  const errEl = document.getElementById('err');
  const barFill = document.getElementById('barFill');

  closeBtn.onclick = () => { try { window.Telegram?.WebApp?.close(); } catch(e) {} window.close(); };

  let sessionId = null;
  let requiredSeconds = 0;
  let started = false;
  let finished = false;
  let t = null;

  function setErr(msg){ errEl.textContent = msg || ''; }
  function setLeft(v){ leftEl.textContent = String(v); barFill.style.width = requiredSeconds ? ((requiredSeconds - v)/requiredSeconds*100).toFixed(1)+'%' : '0%'; }

  async function api(path, body){
    const r = await fetch(path, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body||{}) });
    const j = await r.json().catch(()=> ({}));
    if(!r.ok) throw new Error(j.reason || 'api_error');
    return j;
  }

  async function loadAd(){
    setErr('');
    const data = await api('/api/ad/next', { initData });

    sessionId = data.session_id;
    requiredSeconds = data.requiredSeconds || 10;

    // ödül formatı
    const tl = Number(data.reward_tl || 0).toFixed(2);
    const elmas = Number(data.reward_elmas || 0).toFixed(2);
    rewardEl.textContent = `${tl} TL + ${elmas} ELMAS`;

    setLeft(requiredSeconds);

    if(!data.ad_url){
      setErr('Reklam alınamadı.');
      return;
    }

    vid.src = data.ad_url;
    vid.load();
  }

  function startCountdown(){
    if(started || finished) return;
    started = true;
    let left = requiredSeconds;
    setLeft(left);

    t = setInterval(async () => {
      left -= 1;
      setLeft(left);

      if(left <= 0){
        clearInterval(t);
        finished = true;
        try{
          const done = await api('/api/ad/complete', { initData, session_id: sessionId });
          if(done.ok){
            setErr('✅ Ödül verildi');
            setTimeout(()=>{ try{ window.Telegram?.WebApp?.close(); }catch(e){} }, 800);
          }else{
            setErr('❌ Ödül verilemedi: ' + (done.reason||''));
          }
        }catch(e){
          setErr('❌ Ödül verilemedi: ' + e.message);
        }
      }
    }, 1000);
  }

  // ✅ Sayaç sadece video gerçekten başlayınca çalışır
  vid.addEventListener('play', () => startCountdown());

  // video açılamadıysa complete çağrılmasın
  vid.addEventListener('error', () => setErr('Reklam oynatılamadı (URL/format/CORS).'));
  vid.addEventListener('stalled', () => setErr('Reklam yüklenemedi.'));

  loadAd().catch(e => setErr('Reklam alınamadı: ' + e.message));
</script>
</body>
</html>
